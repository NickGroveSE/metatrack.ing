---
import Layout from '../../layouts/Layout.astro';
import HeroCompass from '../../components/DLHeroCompass.vue';
import CompassFilters from '../../components/CompassFilters.vue'
import HeroList from '../../components/DLHeroList.vue'

import DLLogo from '../../assets/dl-logo.svg';

// Use process.env for server-side runtime variable
const backendUrl = process.env.BACKEND_URL || 'http://backend:8080';
console.log('Using backend URL:', backendUrl);

const { searchParams } = Astro.url;

const nowInMilliseconds = Date.now()
const weekInMilliseconds = 168 * 60 * 60 * 1000 // 168 hours * 60 minutes/hour * 60 seconds/minute * 1000 milliseconds/second

const weekAgoInMilliseconds = nowInMilliseconds - weekInMilliseconds

const unixTimestampNow = Math.floor(nowInMilliseconds / 1000)
const unixTimestampAWeekAgo = Math.floor(weekAgoInMilliseconds / 1000)

const defaults = {
    "min-unix-ts": unixTimestampAWeekAgo.toString(),
    "max-unix-ts": unixTimestampNow.toString(),
    "min-badge": "91",
    "max-badge": "116",
    "min-hero-matches": "0",
    "min-hero-matches-total": "0",
    "heroes": "",
    "combos": "",
}

const finalParams = new URLSearchParams()
Object.entries(defaults).forEach(([key, defaultValue]) => {
  finalParams.set(key, searchParams.get(key) || defaultValue)
})

var response = new Response
try {
  response = await fetch(`${backendUrl}/deadlock?${finalParams.toString()}`);
  
} catch(error){
  console.log(error)
}
const data = await response.json();
var checkedHeroes: any
var visualizedHeroes: any

if (!finalParams.has("heroes") || finalParams.get("heroes") == "") {
  visualizedHeroes = data.data.slice(0, 5);
  checkedHeroes = visualizedHeroes.map((hero: { Heroes: { ID: any; }[]; }) => hero.Heroes[0].ID);
} else {
  console.log("Assigning Checked Heroes...")
  checkedHeroes = finalParams.get("heroes")?.split("~").map(Number)
  
  console.log("Assigning Visualized Heroes...")
  visualizedHeroes = data.data.filter((heroEntity: { Heroes: { ID: any; }[]; }) => 
    checkedHeroes.includes(heroEntity.Heroes[0].ID)
  )
}
---

<Layout title="DL Statistics" logo={DLLogo.src}>
  <main data-all-heroes={JSON.stringify(data.data)}>
    <HeroList 
      class="container" 
      id="hero-list"
      heroData={data.data} 
      setCheckedHeroes={checkedHeroes}
      client:load
    />
    <HeroCompass 
      class="container" 
      id="compass" 
      heroData={visualizedHeroes} 
      client:load
    />
  </main>
</Layout>

<style>
  main {
    padding: 2rem;
    max-width: 1000px;
    margin: 20px auto 0 auto;
    color: white;
  }

  .container {
    display: inline-block;
    vertical-align: top;
  }

  #compass {
    margin-left: 1rem;
  }

</style>

<script>
  const heroList = document.getElementById('hero-list');
  const compass = document.getElementById('compass');
  const main = document.querySelector('main');
  const allHeroData = JSON.parse(main?.dataset.allHeroes || '[]');

  heroList?.addEventListener('checked-heroes-changed', (event) => {
    const customEvent = event as CustomEvent;
    const checkedIds = customEvent.detail;
    const url = new URL(window.location.href);
    const searchParams = new URLSearchParams(url.search);

    console.log('Checked heroes changed:', checkedIds);

    const heroesParam = checkedIds.join("~")

    if (searchParams.has("heroes")) {
      searchParams.set("heroes", heroesParam)
    } else {
      searchParams.append("heroes", heroesParam)
    }
    
    // Filter to get only checked heroes
    const filteredHeroes = allHeroData.filter((hero: { Heroes: { ID: any; }[]; }) => 
      checkedIds.includes(hero.Heroes[0].ID)
    );
    
    // Update compass with custom event
    const updateEvent = new CustomEvent('hero-data-updated', { 
      detail: filteredHeroes
    });

    window.history.pushState({}, '', `${url.pathname}?${searchParams.toString()}`);
    compass?.dispatchEvent(updateEvent);
  });

  heroList?.addEventListener('combo-added', async (event) => {
    const backendUrl = process.env.BACKEND_URL || 'http://localhost:8080';
    const customEvent = event as CustomEvent;
    const checkedHeroes = customEvent.detail.checkedHeroes
    const combosParam = customEvent.detail.combo;
    const url = new URL(window.location.href);
    const searchParams = new URLSearchParams(url.search);

    const nowInMilliseconds = Date.now()
    const weekInMilliseconds = 168 * 60 * 60 * 1000 // 168 hours * 60 minutes/hour * 60 seconds/minute * 1000 milliseconds/second

    const weekAgoInMilliseconds = nowInMilliseconds - weekInMilliseconds

    const unixTimestampNow = Math.floor(nowInMilliseconds / 1000)
    const unixTimestampAWeekAgo = Math.floor(weekAgoInMilliseconds / 1000)

    const requestParams = {
        "min-unix-ts": unixTimestampAWeekAgo.toString(),
        "max-unix-ts": unixTimestampNow.toString(),
        "min-badge": "91",
        "max-badge": "116",
        "min-hero-matches-total": "0",
        "combo": combosParam,
    }

    const newParams = new URLSearchParams()
    Object.entries(requestParams).forEach(([key, value]) => {
      newParams.set(key, value)
    })

    if (searchParams.has("combos")) {
      const allCombos = `${searchParams.get("combos")}~${combosParam}`
      searchParams.set("combos", allCombos)
    } else {
      searchParams.append("combos", combosParam)
    }

    var response = new Response()
    try {
      response = await fetch(`${backendUrl}/deadlock/combo?${newParams.toString()}`);
      
    } catch(error){
      console.log(error)
    }
    const data = await response.json();

    const filteredHeroes = allHeroData.filter((hero: { Heroes: { ID: any; }[]; }) => 
      checkedHeroes.includes(hero.Heroes[0].ID)
    );

    const updatedHeroes = [...filteredHeroes, data.data];
    const updateAllHeroes = [...allHeroData, data.data];

    const updateCompass = new CustomEvent('hero-data-updated', { 
      detail: updatedHeroes
    });

    const updateList = new CustomEvent('hero-list-updated', {
      detail: updateAllHeroes
    })

    window.history.pushState({}, '', `${url.pathname}?${searchParams.toString()}`);
    compass?.dispatchEvent(updateCompass);
    heroList.dispatchEvent(updateList);
  })

</script>